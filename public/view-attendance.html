<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Просмотр посещаемости</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Мониторинг студентов</div>
      <div class="nav-links">
        <a href="create-group.html">Группы</a>
        <a href="mark-attendance.html">Отметка</a>
        <a href="view-attendance.html" class="active">Просмотр</a>
        <a href="#" onclick="logout()">Выход</a>
      </div>
    </header>

    <main>
      <h2>Посещаемость группы</h2>

      <div class="form-group">
        <label>Группа</label>
        <select id="group-select" onchange="loadAttendance();"></select>
      </div>
      <div class="form-group">
        <label>Фильтр по подгруппе (опц.)</label>
        <input type="text" id="subgroup-filter" placeholder="Напр. 1, А, Б" oninput="loadAttendance()">
      </div>
      <div class="form-group">
        <label>Дата начала</label>
        <input type="date" id="date-from" onchange="loadAttendance()">
      </div>
      <div class="form-group">
        <label>Дата окончания</label>
        <input type="date" id="date-to" onchange="loadAttendance()">
      </div>
      <button type="button" class="btn btn-outline" onclick="exportCSV()">Экспорт CSV</button>

      <div style="display: flex; gap: 2rem;">
        <div class="table-responsive" style="flex-grow: 1;">
          <table class="calendar-table" id="attendance-table">
            <thead>
              <tr>
                <th>Студент</th>
                <!-- динамически -->
              </tr>
            </thead>
            <tbody id="attendance-body"></tbody>
          </table>
        </div>

        <!-- Итоговая статистика справа -->
        <div id="summary-stats" style="
          min-width: 200px;
          padding: 1rem;
          background: #f8fafc;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.05);
          font-size: 0.9rem;
          color: #374151;
        ">
          <h4>Итого по таблице</h4>
          <div id="summary-content">
            <p>Присутствовало: <span id="present-count">0</span></p>
            <p>Уважительно: <span id="up-count">0</span></p>
            <p>Неуважительно: <span id="np-count">0</span></p>
            <p>Болел: <span id="b-count">0</span></p>
            <p><strong>Всего отсутствовали: <span id="total-absent">0</span></strong></p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Сначала войдите в систему.');
      window.location.href = 'index.html';
      exit;
    }

    let currentGroupId = null;

    // Загрузить группы
    async function loadGroups() {
      try {
        const res = await fetch('/api/groups', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const groups = await res.json();
        const sel = document.getElementById('group-select');
        sel.innerHTML = '<option value="">Выберите группу</option>';
        groups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = `${g.name} (${g.id})`;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error('Ошибка загрузки групп:', err);
        alert('Не удалось загрузить группы.');
      }
    }

    // Загрузить посещаемость
    async function loadAttendance() {
      const gid = document.getElementById('group-select').value;
      if (!gid) {
        document.getElementById('attendance-body').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:2rem;">Выберите группу</td></tr>';
        updateSummaryStats(0, 0, 0, 0);
        return;
      }
      currentGroupId = gid;

      const from = document.getElementById('date-from').value;
      const to = document.getElementById('date-to').value;
      const subgroupFilter = document.getElementById('subgroup-filter').value.trim();

      try {
        // 1. Получить занятия
        let lessonsUrl = `/api/lessons?group_id=${gid}`;
        const params = new URLSearchParams();
        if (from) params.append('date_from', from);
        if (to) params.append('date_to', to);
        if (subgroupFilter) params.append('subgroup_name', subgroupFilter);
        if (params.toString()) lessonsUrl += '&' + params.toString();

        const lessonsRes = await fetch(lessonsUrl, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const lessons = await lessonsRes.json();

        if (!Array.isArray(lessons)) {
          console.error('Ожидался массив занятий, получено:', lessons);
          document.getElementById('attendance-body').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:2rem;">Нет занятий для этой подгруппы.</td></tr>';
          updateSummaryStats(0, 0, 0, 0);
          return;
        }

        // 2. Получить студентов (с фильтром по подгруппе)
        let studentsUrl = `/api/groups/${gid}/students`;
        if (subgroupFilter) {
          studentsUrl += `?subgroup_name=${encodeURIComponent(subgroupFilter)}`;
        }
        const studentsRes = await fetch(studentsUrl, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const students = await studentsRes.json();

        if (!Array.isArray(students)) {
          console.error('Ожидался массив студентов, получено:', students);
          document.getElementById('attendance-body').innerHTML = '<tr><td colspan="100" style="text-align:center; padding:2rem;">Нет студентов в этой подгруппе.</td></tr>';
          updateSummaryStats(0, 0, 0, 0);
          return;
        }

        // 3. Получить посещаемость
        const lessonIds = lessons.map(l => l.id);
        const studentIds = students.map(s => s.id);

        let attUrl = `/api/attendance/group/${gid}`;
        const attParams = new URLSearchParams();
        if (from) attParams.append('date_from', from);
        if (to) attParams.append('date_to', to);
        if (lessonIds.length > 0) attParams.append('lesson_ids', lessonIds.join(','));
        if (studentIds.length > 0) attParams.append('student_ids', studentIds.join(','));
        if (attParams.toString()) attUrl += '?' + attParams.toString();

        const attRes = await fetch(attUrl, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const attendanceData = await attRes.json();

        // 4. Собрать данные и посчитать статусы
        let presentTotal = 0;
        let upTotal = 0;
        let npTotal = 0;
        let bTotal = 0;

        const result = [];
        for (const student of students) {
          const attRecord = attendanceData.find(r => r.student.id === student.id);
          const studentLessons = [];

          for (const lesson of lessons) {
            if (attRecord && attRecord.lessons) {
              const lessonData = attRecord.lessons.find(l => l.lesson_id === lesson.id);
              const status = lessonData?.status || 'Н';

              // Счётчики
              if (status === 'П') presentTotal++;
              else if (status === 'УП') upTotal++;
              else if (status === 'НП') npTotal++;
              else if (status === 'Б') bTotal++;

              studentLessons.push({
                lesson_id: lesson.id,
                date: lesson.date,
                lesson_num: lesson.lesson_num,
                title: lesson.title,
                status: status,
                note: lessonData?.note || null
              });
            } else {
              const status = 'Н';
              studentLessons.push({
                lesson_id: lesson.id,
                date: lesson.date,
                lesson_num: lesson.lesson_num,
                title: lesson.title,
                status: status,
                note: null
              });
            }
          }

          result.push({
            student: student,
            lessons: studentLessons
          });
        }

        // 5. Генерация таблицы
        const thead = document.querySelector('#attendance-table thead tr');
        thead.innerHTML = '<th>Студент</th>';
        lessons.forEach(lesson => {
          const sub = lesson.subgroup_name ? ` [${lesson.subgroup_name}]` : '';
          thead.innerHTML += `<th class="date-header">${lesson.date}<br><small>№${lesson.lesson_num}${sub}</small></th>`;
        });

        const tbody = document.getElementById('attendance-body');
        tbody.innerHTML = '';
        if (result.length === 0) {
          tbody.innerHTML = '<tr><td colspan="100" style="text-align:center; padding:2rem;">Нет студентов в этой подгруппе.</td></tr>';
          updateSummaryStats(0, 0, 0, 0);
          return;
        }

        result.forEach(item => {
          const { student, lessons: studentLessons } = item;
          const subgroupText = student.subgroup_name ? ` (${student.subgroup_name})` : '';
          let row = `<tr><td>${student.full_name}${subgroupText}</td>`;
          lessons.forEach(lesson => {
            const l = studentLessons.find(it => it.lesson_id === lesson.id);
            const status = l?.status || 'Н';
            row += `<td><span class="status-badge status-${status}">${status}</span></td>`;
          });
          row += '</tr>';
          tbody.innerHTML += row;
        });

        // ✅ Обновляем итоговую статистику
        updateSummaryStats(presentTotal, upTotal, npTotal, bTotal);

      } catch (err) {
        console.error('Ошибка загрузки посещаемости:', err);
        document.getElementById('attendance-body').innerHTML = `<tr><td colspan="100" style="text-align:center; color:#f87171; padding:2rem;">Ошибка: ${err.message}</td></tr>`;
        updateSummaryStats(0, 0, 0, 0);
      }
    }

    // Обновить итоговую статистику справа
    function updateSummaryStats(present, up, np, b) {
      document.getElementById('present-count').textContent = present;
      document.getElementById('up-count').textContent = up;
      document.getElementById('np-count').textContent = np;
      document.getElementById('b-count').textContent = b;
      document.getElementById('total-absent').textContent = up + np + b;
    }

    // Экспорт CSV
    async function exportCSV() {
      const gid = document.getElementById('group-select').value;
      if (!gid) {
        alert('Выберите группу');
        return;
      }

      const from = document.getElementById('date-from').value;
      const to = document.getElementById('date-to').value;
      const subgroupFilter = document.getElementById('subgroup-filter').value.trim();

      let url = `/api/attendance/export/csv/${gid}`;
      const params = new URLSearchParams();
      if (from) params.append('date_from', from);
      if (to) params.append('date_to', to);
      if (subgroupFilter) params.append('subgroup_name', subgroupFilter);
      if (params.toString()) url += '?' + params.toString();

      window.open(url, '_blank');
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }

    // Инициализация
    loadGroups();
  </script>
</body>
</html>