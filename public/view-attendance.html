<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Просмотр посещаемости</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Мониторинг студентов</div>
      <div class="nav-links">
        <a href="create-group.html">Группы</a>
        <a href="mark-attendance.html">Отметка</a>
        <a href="view-attendance.html" class="active">Просмотр</a>
        <a href="#" onclick="logout()">Выход</a>
      </div>
    </header>

    <h2>Посещаемость группы</h2>

    <div class="form-group">
      <label>Группа</label>
      <select id="group-select" onchange="loadStats()"></select>
    </div>
    <div class="form-group">
      <label>Период</label>
      <select id="period-select">
        <option value="day">День</option>
        <option value="week">Неделя</option>
        <option value="month">Месяц</option>
      </select>
    </div>
    <div class="form-group">
      <label>Дата начала</label>
      <input type="date" id="date-from">
    </div>
    <div class="form-group">
      <label>Дата окончания</label>
      <input type="date" id="date-to">
    </div>
    <button type="button" class="btn" onclick="loadAttendance()">Загрузить</button>
    <button type="button" class="btn btn-outline" onclick="exportCSV()">Экспорт CSV</button>

    <div class="stats-grid" id="stats"></div>

    <div class="table-responsive">
      <table class="calendar-table" id="attendance-table">
        <thead>
          <tr>
            <th>Студент</th>
            <!-- динамически -->
          </tr>
        </thead>
        <tbody id="attendance-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'index.html';

    let currentGroupId = null;
    let lessonsMap = {};

    async function loadGroups() {
      const res = await fetch('/api/groups', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const groups = await res.json();
      const sel = document.getElementById('group-select');
      groups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        sel.appendChild(opt);
      });
    }

    async function loadStats() {
      const gid = document.getElementById('group-select').value;
      if (!gid) return;
      currentGroupId = gid;

      const res = await fetch(`/api/stats/group/${gid}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const stats = await res.json();
      const container = document.getElementById('stats');
      container.innerHTML = `
        <div class="stat-card stat-present">
          <div>Всего студентов</div>
          <div class="stat-value">${stats.total_students}</div>
        </div>
        <div class="stat-card stat-present">
          <div>Присутствовали</div>
          <div class="stat-value">${stats.present}</div>
        </div>
        <div class="stat-card stat-absent">
          <div>Отсутствовали</div>
          <div class="stat-value">${stats.absent}</div>
        </div>
        <div class="stat-card stat-lesson">
          <div>Пара №</div>
          <div class="stat-value">3</div>
        </div>
      `;
    }

    async function loadAttendance() {
      const gid = document.getElementById('group-select').value;
      const from = document.getElementById('date-from').value;
      const to = document.getElementById('date-to').value;

      if (!gid) return alert('Выберите группу');

      const res = await fetch(`/api/attendance/group/${gid}?date_from=${from}&date_to=${to}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();

      // Собираем все уникальные даты/занятия
      const allLessons = new Set();
      data.forEach(s => s.lessons.forEach(l => allLessons.add(`${l.date}|${l.lesson_num}|${l.title}`)));
      const lessonKeys = Array.from(allLessons).sort();

      // Заголовки
      const thead = document.querySelector('#attendance-table thead tr');
      thead.innerHTML = '<th>Студент</th>';
      lessonKeys.forEach(key => {
        const [date, num, title] = key.split('|');
        thead.innerHTML += `<th class="date-header">${date}<br><small>№${num}</small></th>`;
      });

      // Тело
      const tbody = document.getElementById('attendance-body');
      tbody.innerHTML = '';
      data.forEach(student => {
        let row = `<tr><td>${student.student.full_name}</td>`;
        lessonKeys.forEach(key => {
          const lesson = student.lessons.find(l => 
            `${l.date}|${l.lesson_num}|${l.title}` === key
          );
          const status = lesson?.status || 'Н';
          row += `<td><span class="status-badge status-${status}">${status}</span></td>`;
        });
        row += '</tr>';
        tbody.innerHTML += row;
      });
    }

    async function exportCSV() {
      const gid = document.getElementById('group-select').value;
      const from = document.getElementById('date-from').value;
      const to = document.getElementById('date-to').value;

      if (!gid) return alert('Выберите группу');

      const url = `/api/attendance/export/csv/${gid}${from ? `?date_from=${from}` : ''}${to ? (from ? `&date_to=${to}` : `?date_to=${to}`) : ''}`;
      window.open(url, '_blank');
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }

    loadGroups();
  </script>
</body>
</html>