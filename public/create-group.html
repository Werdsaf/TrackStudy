<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
      <div class="nav-links">
        <a href="create-group.html" class="active">–ì—Ä—É–ø–ø—ã</a>
        <a href="mark-attendance.html">–û—Ç–º–µ—Ç–∫–∞</a>
        <a href="view-attendance.html">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
        <a href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
      </div>
    </header>

    <main>
      <h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
      <form id="group-form">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
          <input type="text" id="group-name" required placeholder="–ù–∞–ø—Ä. –ò–¢-204">
        </div>
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü.)</label>
          <textarea id="group-desc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        </div>
        <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
      </form>

      <hr style="margin: 2rem 0;">

      <h2>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø—É</h2>
      <p style="color: #6b7280; margin-bottom: 1rem;">
        üîπ –í–≤–µ–¥–∏—Ç–µ <strong>ID –≥—Ä—É–ø–ø—ã</strong> (—Å–º. —Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –≤—ã—à–µ)<br>
        üîπ Email ‚Äî –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
      </p>

      <div class="form-group">
        <label>ID –≥—Ä—É–ø–ø—ã</label>
        <input type="number" id="group-id" placeholder="–ù–∞–ø—Ä. 3" required>
      </div>

      <div id="students-list">
        <div class="student-input">
          <input type="text" placeholder="–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞" class="student-name" required>
          <input type="email" placeholder="Email (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="student-email">
          <button type="button" class="btn btn-outline" onclick="addStudentInput()">+</button>
        </div>
      </div>

      <button type="button" class="btn" onclick="saveStudents()">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</button>

      <div id="groups-list" style="margin-top: 2rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
        <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã</h3>
        <ul id="group-items" style="list-style: none; padding: 0;">
          <!-- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </ul>
      </div>
    </main>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
      window.location.href = 'index.html';
      exit;
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
    async function loadGroups() {
      try {
        const res = await fetch('/api/groups', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const groups = await res.json();

        const ul = document.getElementById('group-items');
        if (groups.length === 0) {
          ul.innerHTML = '<li>–ì—Ä—É–ø–ø—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É –≤—ã—à–µ.</li>';
          return;
        }

        ul.innerHTML = groups.map(g => 
          `<li><strong>ID:</strong> ${g.id} | <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${g.name} ${g.description ? `‚Äî ${g.description}` : ''}</li>`
        ).join('');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', err);
        document.getElementById('group-items').innerHTML = '<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø.</li>';
      }
    }

    // –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
    document.getElementById('group-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('group-name').value.trim();
      const desc = document.getElementById('group-desc').value.trim();

      if (!name) {
        alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
        return;
      }

      try {
        const res = await fetch('/api/groups', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, description: desc })
        });

        const group = await res.json();
        if (res.ok) {
          alert(`‚úÖ –ì—Ä—É–ø–ø–∞ "${group.name}" —Å–æ–∑–¥–∞–Ω–∞. ID: ${group.id}`);
          loadGroups();
          document.getElementById('group-name').value = '';
          document.getElementById('group-desc').value = '';
        } else {
          alert(group.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã');
        }
      } catch (err) {
        alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      }
    });

    // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ —Å—Ç—É–¥–µ–Ω—Ç–∞
    let studentInputs = [document.querySelector('.student-input')];
    function addStudentInput() {
      const div = document.createElement('div');
      div.className = 'student-input';
      div.innerHTML = `
        <input type="text" placeholder="–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞" class="student-name" required>
        <input type="email" placeholder="Email (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="student-email">
        <button type="button" class="btn btn-outline" onclick="removeStudentInput(this)">√ó</button>
      `;
      document.getElementById('students-list').appendChild(div);
      studentInputs.push(div);
    }

    function removeStudentInput(btn) {
      btn.closest('.student-input').remove();
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
    async function saveStudents() {
      const groupId = parseInt(document.getElementById('group-id').value);
      if (!groupId) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –≥—Ä—É–ø–ø—ã');
        return;
      }

      const students = [];
      document.querySelectorAll('.student-input').forEach(el => {
        const name = el.querySelector('.student-name').value.trim();
        const email = el.querySelector('.student-email').value.trim();
        if (name) {
          students.push({
            full_name: name,
            email: email || null  // NULL —Ä–∞–∑—Ä–µ—à—ë–Ω –≤ –ë–î
          });
        }
      });

      if (students.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)');
        return;
      }

      try {
        const res = await fetch(`/api/groups/${groupId}/students`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(students)
        });

        const data = await res.json();
        if (res.ok) {
          alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${students.length} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø—É ID=${groupId}`);
          // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è
          document.querySelectorAll('.student-input').forEach(el => {
            el.querySelector('.student-name').value = '';
            el.querySelector('.student-email').value = '';
          });
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
        }
      } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadGroups();
  </script>
</body>
</html>