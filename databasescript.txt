-- ================================================
-- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•: –°—Ç—É–¥–µ–Ω—Ç—ã –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å
-- ================================================

-- üõ†Ô∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ:
-- 1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ PostgreSQL: psql -U postgres
-- 2. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É: CREATE DATABASE attendance_db;
-- 3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –Ω–µ–π: \c attendance_db
-- 4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: \i sql/init.sql

-- ================================================
-- 1. –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫—É—Ä–∞—Ç–æ—Ä)
-- ================================================

CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password TEXT NOT NULL,
  role VARCHAR(10) DEFAULT 'curator' CHECK (role = 'curator'),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ================================================
-- 2. –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–ø–ø
-- ================================================

CREATE TABLE groups (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  created_by INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ================================================
-- 3. –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
-- ================================================

CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  full_name VARCHAR(255) NOT NULL,
  email VARCHAR(255), -- —Ç–µ–ø–µ—Ä—å –ù–ï —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏ –ù–ï –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π
  group_id INT NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ================================================
-- 4. –¢–∞–±–ª–∏—Ü–∞ –∑–∞–Ω—è—Ç–∏–π
-- ================================================

CREATE TABLE lessons (
  id SERIAL PRIMARY KEY,
  date DATE NOT NULL,
  lesson_num SMALLINT NOT NULL,
  title VARCHAR(100) NOT NULL,
  group_id INT NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  subgroups JSONB, -- –Ω–∞–ø—Ä. [1, 2, 3] ‚Äî IDs —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ–¥–≥—Ä—É–ø–ø—ã; NULL = –≤—Å—è –≥—Ä—É–ø–ø–∞
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ================================================
-- 5. –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
-- ================================================

CREATE TABLE attendance (
  id SERIAL PRIMARY KEY,
  student_id INT NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  lesson_id INT NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
  status VARCHAR(3) NOT NULL CHECK (status IN ('–ü', '–ë', '–ù–ü', '–£–ü', '–ù')),
  note TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –æ–¥–∏–Ω —Å—Ç—É–¥–µ–Ω—Ç ‚Äî –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –æ–¥–Ω–æ –∑–∞–Ω—è—Ç–∏–µ
  UNIQUE (student_id, lesson_id)
);

-- ================================================
-- 6. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
-- ================================================

-- –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π –ø–æ –≥—Ä—É–ø–ø–µ –∏ –¥–∞—Ç–µ
CREATE INDEX idx_lessons_group_date ON lessons (group_id, date);

-- –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ –∑–∞–Ω—è—Ç–∏—é
CREATE INDEX idx_attendance_lesson ON attendance (lesson_id);

-- –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ —Å—Ç—É–¥–µ–Ω—Ç—É
CREATE INDEX idx_attendance_student ON attendance (student_id);

-- ================================================
-- 7. –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-- ================================================

-- INSERT INTO users (email, password, role) VALUES ('curator@example.com', '$2a$10$...', 'curator');
-- INSERT INTO groups (name, description, created_by) VALUES ('–ò–¢-204', '–ì—Ä—É–ø–ø–∞ –≤—Ç–æ—Ä–æ–≥–æ –∫—É—Ä—Å–∞', 1);
-- INSERT INTO students (full_name, email, group_id) VALUES ('–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω', 'ivan@example.com', 1);
-- INSERT INTO students (full_name, email, group_id) VALUES ('–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä', NULL, 1);
-- INSERT INTO lessons (date, lesson_num, title, group_id, subgroups) VALUES ('2026-02-15', 1, '–í–≤–µ–¥–µ–Ω–∏–µ –≤ Node.js', 1, '[1,2]');
-- INSERT INTO attendance (student_id, lesson_id, status, note) VALUES (1, 1, '–ü', NULL);

-- ================================================
-- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞!
-- ================================================