-- Таблица пользователей (кураторы)
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password TEXT NOT NULL,
  role VARCHAR(50) DEFAULT 'curator',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица групп (с привязкой к куратору)
CREATE TABLE groups (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  created_by INT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE
);

-- Таблица студентов
CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  full_name VARCHAR(255) NOT NULL,
  email VARCHAR(255),
  group_id INT NOT NULL,
  subgroup_id INT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);

-- Таблица занятий
CREATE TABLE lessons (
  id SERIAL PRIMARY KEY,
  date DATE NOT NULL,
  lesson_num INT NOT NULL,
  title VARCHAR(255) NOT NULL,
  group_id INT NOT NULL,
  subgroup_id INT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);

-- Таблица посещаемости
CREATE TABLE attendance (
  id SERIAL PRIMARY KEY,
  student_id INT NOT NULL,
  lesson_id INT NOT NULL,
  status VARCHAR(10) NOT NULL CHECK (status IN ('П', 'Б', 'НП', 'УП', 'Н')),
  note TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
  FOREIGN KEY (lesson_id) REFERENCES lessons(id) ON DELETE CASCADE,
  UNIQUE (student_id, lesson_id)
);

-- Индексы для ускорения запросов
CREATE INDEX idx_users_email ON users(email);

CREATE INDEX idx_students_group ON students(group_id);
CREATE INDEX idx_students_group_subgroup ON students (group_id, subgroup_id);

CREATE INDEX idx_lessons_group ON lessons(group_id);
CREATE INDEX idx_lessons_group_date ON lessons (group_id, date);
CREATE INDEX idx_lessons_group_subgroup ON lessons (group_id, subgroup_id);

CREATE INDEX idx_attendance_student_lesson ON attendance(student_id, lesson_id);
CREATE INDEX idx_attendance_lesson ON attendance (lesson_id);
CREATE INDEX idx_attendance_student ON attendance (student_id);