-- sql/init.sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password TEXT NOT NULL,
  role VARCHAR(10) DEFAULT 'curator' CHECK (role = 'curator'),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE groups (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  created_by INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  full_name VARCHAR(255) NOT NULL,
  email VARCHAR(255),
  group_id INT NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  subgroup_name VARCHAR(50),  -- ← Подгруппа студента
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE lessons (
  id SERIAL PRIMARY KEY,
  date DATE NOT NULL,
  lesson_num SMALLINT NOT NULL,
  title VARCHAR(100) NOT NULL,
  group_id INT NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  subgroup_name VARCHAR(50),  -- ← Подгруппа занятия (если задана)
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE attendance (
  id SERIAL PRIMARY KEY,
  student_id INT NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  lesson_id INT NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
  status VARCHAR(3) NOT NULL CHECK (status IN ('П', 'Б', 'НП', 'УП', 'Н')),
  note TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (student_id, lesson_id)
);

-- Индексы
CREATE INDEX idx_lessons_group_date ON lessons (group_id, date);
CREATE INDEX idx_attendance_lesson ON attendance (lesson_id);
CREATE INDEX idx_attendance_student ON attendance (student_id);
CREATE INDEX idx_students_group_subgroup ON students (group_id, subgroup_name);
CREATE INDEX idx_lessons_group_subgroup ON lessons (group_id, subgroup_name);